(this.webpackJsonpime2=this.webpackJsonpime2||[]).push([[0],{134:function(t,e,i){"use strict";i.r(e);var n,s=i(11),o=i.n(s),a=i(55),r=i.n(a),c=(i(70),i(17)),h=i.n(c),u=i(22),d=i(0),l=i(1),f=i(7),v=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return Math.round(t*Math.pow(10,e))/Math.pow(10,e)},g=function(){function t(){Object(d.a)(this,t),this.dict={},this.chunksDicts=void 0,this.borders=void 0,this.chunkSizes=[40,20,10,5],this.chunksDicts=this.chunkSizes.map((function(){return{}}));for(var e=-100;e<=0;e++)for(var i=-2;i<=2;i++)for(var n=-2;n<=2;n++)this.dict[this.getKeyFromPosition({x:i,y:n,z:e})]=1;for(var s=-103;s<=-100;s++)for(var o=-100;o<=100;o++)for(var a=-100;a<=100;a++)this.dict[this.getKeyFromPosition({x:o,y:a,z:s})]=1;for(var r=46;r<=50;r++)for(var c=50;c<=54;c++)this.dict[this.getKeyFromPosition({x:r,y:c,z:100})]=1;this.dict[this.getKeyFromPosition({x:49,y:55,z:100})]=1,this.dict[this.getKeyFromPosition({x:47,y:55,z:100})]=1,this.dict[this.getKeyFromPosition({x:49,y:56,z:100})]=1,this.dict[this.getKeyFromPosition({x:47,y:56,z:100})]=1,this.dict[this.getKeyFromPosition({x:48,y:56,z:100})]=1;var h=this.getPositionFromKey(Object.keys(this.dict)[0]);this.borders={xMin:h.x,xMax:h.x,yMin:h.y,yMax:h.y,zMin:h.z,zMax:h.z},this.setChunksAndBorders()}return Object(l.a)(t,[{key:"getKeyFromPosition",value:function(t){return JSON.stringify(t)}},{key:"getPositionFromKey",value:function(t){return JSON.parse(t)}},{key:"getChunkPosition",value:function(t,e){return{a:v((e.y-e.x)/t),b:v((e.y+e.x+e.z/3)/t),c:v(e.z/t)}}},{key:"getChunkKeyFromChunkPosition",value:function(t){return JSON.stringify({a:Math.floor(t.a),b:Math.floor(t.b),c:Math.floor(t.c)})}},{key:"getChunkKeyFromPosition",value:function(t,e){return this.getChunkKeyFromChunkPosition(this.getChunkPosition(t,e))}},{key:"getTileAt",value:function(t){return this.dict[this.getKeyFromPosition(t)]}},{key:"setChunksAndBorders",value:function(){var t=this;Object.keys(this.dict).forEach((function(e){var i=t.getPositionFromKey(e);i.x<t.borders.xMin&&(t.borders.xMin=i.x),i.x>t.borders.xMax&&(t.borders.xMax=i.x),i.y<t.borders.yMin&&(t.borders.yMin=i.y),i.y>t.borders.yMax&&(t.borders.yMax=i.y),i.z<t.borders.zMin&&(t.borders.zMin=i.z),i.z>t.borders.zMax&&(t.borders.zMax=i.z),t.chunksDicts.forEach((function(e,n){e[t.getChunkKeyFromPosition(t.chunkSizes[n],i)]=!0}))}))}},{key:"_crossSectionIsEmpty",value:function(t,e,i,n){for(var s=this.getChunkPosition(e,i),o=this.getChunkPosition(e,n),a=Math.floor(s.a);a<=o.a;a++)for(var r=Math.floor(s.c);r<=o.c;r++)if(t[this.getChunkKeyFromChunkPosition({a:a,b:s.b,c:r})])return!1;return!0}},{key:"crossSectionIsEmpty",value:function(t,e){for(var i=Object(f.a)(Object(f.a)({},t),{},{z:Math.min(this.borders.zMax,Math.max(this.borders.zMin,t.z))}),n=Object(f.a)(Object(f.a)({},e),{},{z:Math.min(this.borders.zMax,Math.max(this.borders.zMin,e.z))}),s=0;s<this.chunksDicts.length;s++)if(!0===this._crossSectionIsEmpty(this.chunksDicts[s],this.chunkSizes[s],i,n))return!0;return!1}}]),t}(),x=i(29),b=function(){function t(e){Object(d.a)(this,t),this.idFields=e,this.dict={}}return Object(l.a)(t,[{key:"getId",value:function(t){var e={};return this.idFields.forEach((function(i){e[i]=t[i]})),JSON.stringify(e)}},{key:"addEntry",value:function(t){this.dict[this.getId(t)]=t}},{key:"getEntry",value:function(t){return this.dict[this.getId(t)]}}]),t}(),y=new b(["name"]),m=function(){function t(e){Object(d.a)(this,t),this.name=e,this.url=void 0,this.imageJs=void 0,this.canvas=void 0,this._isLoaded=!1,this.url="".concat("","/").concat(e,".png"),y.addEntry(this)}return Object(l.a)(t,[{key:"isLoaded",value:function(){return this._isLoaded}},{key:"load",value:function(){var t=Object(u.a)(h.a.mark((function t(){var e;return h.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,x.a.load(this.url);case 2:e=t.sent,this.imageJs=e,this.canvas=this.imageJs.getCanvas(),this._isLoaded=!0;case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}],[{key:"getResource",value:function(t){return y.getEntry({name:t})}},{key:"getLoadedResource",value:function(t){var e=y.getEntry({name:t});if(e&&e.isLoaded())return e}}]),t}(),w=i(4),P=new b(["type","neighborhood"]);!function(t){t[t.FTL=64329]="FTL",t[t.LSL=63735]="LSL",t[t.LSB=10280]="LSB",t[t.LST=62509]="LST",t[t.FBL=65277]="FBL",t[t.LSR=57567]="LSR",t[t.FTR=53199]="FTR",t[t.FBR=0]="FBR",t[t.RSL=59623]="RSL",t[t.RSB=27296]="RSB",t[t.RST=16824]="RST",t[t.RSR=61807]="RSR"}(n||(n={}));var k=function(){function t(e,i){var n;Object(d.a)(this,t),this.type=e,this.neighborhood=i,this.imageJs=void 0,this.canvas=void 0,this.maskResource=void 0,this.tileResource=void 0;var s=m.getLoadedResource(e);if(!s)throw new Error("Resource '".concat(e,"' hasn't been loaded."));var o=m.getLoadedResource("mask");if(!o)throw new Error("Resource '".concat("mask","' hasn't been loaded."));this.tileResource=s,this.maskResource=o,this.imageJs=this.makeImageJs(),this.canvas=null===(n=this.imageJs)||void 0===n?void 0:n.getCanvas(),P.addEntry(this)}return Object(l.a)(t,[{key:"makeImageJs",value:function(){var t=this.neighborhood,e=t.above,i=t.topLeft,s=t.topRight,o=t.bottomLeft,a=t.bottomRight,r=t.under;if(!(e&&o&&a)){for(var c=this.tileResource.imageJs,h=this.maskResource.imageJs,u=new x.a(32,24,void 0,{bitDepth:16}),d=0;d<32;d++)for(var l=0;l<24;l++){u.setPixelXY(d,l,[0,0,0,0]);var f=h.getPixelXY(d,l);if(f[0]!==n.FTL)if(f[0]!==n.FTR)if(f[0]!==n.FBL)if(f[0]!==n.FBR)if(f[0]!==n.LSL)if(f[0]!==n.LST)if(f[0]!==n.LSB)if(f[0]!==n.LSR)if(f[0]!==n.RSR)if(f[0]!==n.RST)if(f[0]!==n.RSB)if(f[0]!==n.RSL);else{if(!0===a){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===o){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===a){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===r){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===a){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===e){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===a){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===s){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===o){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===a){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===o){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===r){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===o){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===e){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===o){if(!0===e)continue;u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)));continue}if(!1===i){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+48)))}else{if(!0===e)continue;if(!1===a){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)))}else{if(!0===e)continue;if(!1===o){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)))}else{if(!0===e)continue;if(!1===s){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)))}else{if(!0===e)continue;if(!1===i){u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l)));continue}u.setPixelXY(d,l,Object(w.a)(c.getPixelXY(d,l+24)))}}return u}}}],[{key:"getTile",value:function(t,e){return P.getEntry({type:t,neighborhood:e})}},{key:"getOrMakeTile",value:function(e,i){var n=P.getEntry({type:e,neighborhood:i});return n||new t(e,i)}}]),t}(),O=function(){function t(e,i,n,s,o){Object(d.a)(this,t),this.viewConeCenter=e,this.focal=i,this.viewConeWindow=n,this.distanceFromCenter=s,this.tileMap=o,this.center=void 0,this.scale=void 0,this.window=void 0,this.extendedWindow=void 0,this.heightConstraint=void 0,this.crossSectionConstant=void 0,this.tilesDict=void 0,this.margin=void 0,this.canvas1=void 0,this.context1=void 0,this.canvas2=void 0,this.context2=void 0,this.canvas1IsMain=!0,this.dx=0,this.dy=0,this.center={x:e.x-s/8,y:e.y-s/8,z:e.z-s/4},this.scale=1+s/i,this.window={a1:Math.round(n.a1*this.scale),a2:Math.round(n.a2*this.scale),b1:Math.round(n.b1*this.scale),b2:Math.round(n.b2*this.scale)},this.margin=32,this.extendedWindow={a1:this.window.a1-this.margin,a2:this.window.a2+this.margin,b1:this.window.b1-this.margin,b2:this.window.b2+this.margin},this.heightConstraint=t.getHeightConstraint(e.z-s),this.crossSectionConstant=this.center.x+this.center.y+this.center.z/3,this.tilesDict=this.makeTilesDict()}return Object(l.a)(t,[{key:"newCanvasAndContext",value:function(){var t=new OffscreenCanvas(this.extendedWidth,this.extendedHeight),e=t.getContext("2d");if(!e)throw new Error("Context cannot be null");return e.imageSmoothingEnabled=!1,{canvas:t,context:e}}},{key:"paintCanvas",value:function(){var t=this,e=this.tiles;if(0!==e.length&&!e.every((function(t){return!t.tile.canvas}))){if(!this.context){var i=this.newCanvasAndContext(),n=i.canvas,s=i.context;this.canvas1=n,this.context1=s;var o=this.newCanvasAndContext(),a=o.canvas,r=o.context;this.canvas2=a,this.context2=r}e.forEach((function(e){var i=e.crossSectionPosition,n=i.a,s=i.b,o=e.tile;o.canvas&&t.context&&t.context.drawImage(o.canvas,t.extendedWidth/2+(n-16),t.extendedHeight/2+(-s-8),o.canvas.width,o.canvas.height)}))}}},{key:"getA",value:function(t){var e=t.x;return 16*(t.y-this.center.y-(e-this.center.x))}},{key:"getB",value:function(t){return 32/3*(t.z-this.center.z)}},{key:"getCrossSectionPosition",value:function(t){return{a:this.getA(t),b:this.getB(t)}}},{key:"getProjetedCrossSectionPosition",value:function(t){return{a:this.getA(t)/this.scale,b:this.getB(t)/this.scale}}},{key:"getX",value:function(t){var e=t.a,i=t.b;return this.center.x-e/32-i/64}},{key:"getY",value:function(t){var e=t.a,i=t.b;return this.center.y+e/32-i/64}},{key:"getZ",value:function(t){var e=t.b;return this.center.z+3*e/32}},{key:"getPosition",value:function(t){return{x:this.getX(t),y:this.getY(t),z:this.getZ(t)}}},{key:"forEachTilePosition",value:function(e,i,n){var s=this.extendedWindow,o=s.a1,a=s.a2,r=s.b1,c=s.b2,h=this.heightConstraint,u=Math.ceil(this.getZ({b:r}));i&&i>u&&(u=i);var d=t.getHeightConstraint(u);d!==h&&(u+=t.getHeightConstraint(h-d));var l=Math.floor(this.getZ({b:c}));n&&n<l&&(l=n);var f=t.getHeightConstraint(l);f!==h&&(l-=t.getHeightConstraint(-h+f));for(var v=u;v<=l;v+=3)for(var g=this.getB({z:v}),x=Math.ceil(this.getY({a:o,b:g})),b=Math.floor(this.getY({a:a,b:g})),y=x;y<=b;y++){e({x:Math.round(this.crossSectionConstant-y-v/3),y:y,z:v})}}},{key:"makeTilesDict",value:function(){var e=this,i={},n=this.tileMap,s=this.extendedWindow,o=s.a1,a=s.a2,r=s.b1,c=s.b2;return n.crossSectionIsEmpty(this.getPosition({a:o,b:r}),this.getPosition({a:a,b:c}))||this.forEachTilePosition((function(s){if(n.getTileAt(s)){var o={above:1===n.getTileAt(Object(f.a)(Object(f.a)({},s),{},{z:s.z+1})),bottomLeft:1===n.getTileAt(Object(f.a)(Object(f.a)({},s),{},{x:s.x+1})),bottomRight:1===n.getTileAt(Object(f.a)(Object(f.a)({},s),{},{y:s.y+1})),topLeft:1===n.getTileAt(Object(f.a)(Object(f.a)({},s),{},{y:s.y-1})),topRight:1===n.getTileAt(Object(f.a)(Object(f.a)({},s),{},{x:s.x-1})),under:1===n.getTileAt(Object(f.a)(Object(f.a)({},s),{},{z:s.z-1}))},a=k.getOrMakeTile("tile2",o);i[t.getTileId(s)]={position:s,crossSectionPosition:e.getCrossSectionPosition(s),tile:a}}}),n.borders.zMin,n.borders.zMax),i}},{key:"move",value:function(t){this.center={x:t.x-this.distanceFromCenter/8,y:t.y-this.distanceFromCenter/8,z:t.z-this.distanceFromCenter/4},this.dx+=1}},{key:"sprite",get:function(){if(this.canvas)return{image:this.canvas,sx:this.margin+this.dx,sy:this.margin+this.dy,sw:this.canvas.width-2*this.margin,sh:this.canvas.height-2*this.margin}}},{key:"canvas",get:function(){return this.canvas1IsMain?this.canvas1:this.canvas2}},{key:"context",get:function(){return this.canvas1IsMain?this.context1:this.context2}},{key:"width",get:function(){return this.window.a2-this.window.a1}},{key:"height",get:function(){return this.window.b2-this.window.b1}},{key:"extendedWidth",get:function(){return this.extendedWindow.a2-this.extendedWindow.a1}},{key:"extendedHeight",get:function(){return this.extendedWindow.b2-this.extendedWindow.b1}},{key:"tiles",get:function(){return Object.values(this.tilesDict)}}],[{key:"getHeightConstraint",value:function(t){return(3+t%3)%3}},{key:"getTileId",value:function(t){return JSON.stringify(t)}}]),t}(),C=i(64),j=i.n(C),Y=function(){function t(e,i,n,s,o,a){Object(d.a)(this,t),this.center=e,this.focal=i,this.rendererWindow=n,this.startDistanceFromCenter=s,this.tileMap=o,this.zoom=a,this.crossSections=[],this.maxDistanceFromCenter=void 0,this.sprites=[],this.canvas=void 0,this.context=void 0,this.maxDistanceFromCenter=s-1;var r=this.newCanvasAndContext(),c=r.canvas,h=r.context;this.canvas=c,this.context=h}return Object(l.a)(t,[{key:"newCanvasAndContext",value:function(){var t=new OffscreenCanvas(this.width*this.zoom,this.height*this.zoom),e=t.getContext("2d");if(!e)throw new Error("Context cannot be null");return e.imageSmoothingEnabled=!1,{canvas:t,context:e}}},{key:"paintCanvas",value:function(){var t=this;j.a.orderBy(this.crossSections,["distanceFromCenter"],["desc"]).forEach((function(e){var i=e.sprite;i&&t.context.drawImage(i.image,i.sx,i.sy,i.sw,i.sh,0,0,t.canvas.width,t.canvas.height)}))}},{key:"discover",value:function(t){for(var e=this.maxDistanceFromCenter,i=e+1;i<=e+t;i++){var n=new O(this.center,this.focal,this.window,i,this.tileMap);this.crossSections.push(n),this.maxDistanceFromCenter=i-1}}},{key:"move",value:function(t){this.center=t,this.crossSections.forEach((function(e){e.move(t)})),this.paintCanvas()}},{key:"window",get:function(){return{a1:this.rendererWindow.a1/this.zoom,a2:this.rendererWindow.a2/this.zoom,b1:this.rendererWindow.b1/this.zoom,b2:this.rendererWindow.b2/this.zoom}}},{key:"width",get:function(){return this.window.a2-this.window.a1}},{key:"height",get:function(){return this.window.b2-this.window.b1}}]),t}(),X=function(){function t(e,i){Object(d.a)(this,t),this.canvas=e,this.tileMap=i,this.context=void 0,this.viewCone=void 0,this.framesDuration=Object(w.a)(Array(30)).fill(0),this.lastTime=0,this.frameIndex=0;var n=this.canvas.getContext("2d");if(!n)throw new Error("Context cannot be null");n.imageSmoothingEnabled=!1,this.context=n;var s=this.canvas.width,o=this.canvas.height,a=Math.pow(4,1),r=Math.pow(4,0),c={a1:-s/2/r,a2:s/2/r,b1:-o/2/r,b2:o/2/r};console.time("new ViewCone"),this.viewCone=new Y({x:-2,y:-2,z:0},1e3,c,-500,i,a),console.timeEnd("new ViewCone"),console.time("discover"),this.viewCone.discover(2e3),console.timeEnd("discover"),console.time("sprite"),this.viewCone.crossSections.forEach((function(t){return t.paintCanvas()})),this.viewCone.paintCanvas(),console.timeEnd("sprite"),this.lastTime=Date.now(),this.renderLoop()}return Object(l.a)(t,[{key:"renderLoop",value:function(){var t=this,e=Date.now()-this.lastTime;this.lastTime=Date.now(),this.framesDuration.push(e),this.framesDuration.shift(),this.frameIndex++%30===0&&console.log(this.fps.toFixed(1)),this.paintCanvas(),this.viewCone.move({x:0,y:0,z:0}),requestAnimationFrame((function(){return t.renderLoop()}))}},{key:"paintCanvas",value:function(){this.context.drawImage(this.viewCone.canvas,0,0,this.canvas.width,this.canvas.height)}},{key:"fps",get:function(){return this.framesDuration.length/this.framesDuration.reduce((function(t,e){return t+e}),0)*1e3}}]),t}(),p=function(){function t(e){Object(d.a)(this,t),this.canvas=e}return Object(l.a)(t,[{key:"start",value:function(){var t=Object(u.a)(h.a.mark((function t(){var e,i,n,s;return h.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=new m("tile1"),t.next=3,e.load();case 3:return i=new m("tile2"),t.next=6,i.load();case 6:return n=new m("mask"),t.next=9,n.load();case 9:s=new g,new X(this.canvas,s);case 11:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}]),t}(),z=function(){var t=Object(s.useRef)(null);return Object(s.useEffect)((function(){t&&t.current&&new p(t.current).start()}),[t]),o.a.createElement(o.a.Fragment,null,o.a.createElement("canvas",{width:1600,height:800,ref:t,style:{border:"1px solid black",margin:"20px"}}))},M=function(){return o.a.createElement("div",null,o.a.createElement("p",null,"IME"),o.a.createElement(z,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));r.a.render(o.a.createElement(o.a.StrictMode,null,o.a.createElement(M,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(t){t.unregister()})).catch((function(t){console.error(t.message)}))},65:function(t,e,i){t.exports=i(134)},70:function(t,e,i){}},[[65,1,2]]]);
//# sourceMappingURL=main.bb84e7d7.chunk.js.map